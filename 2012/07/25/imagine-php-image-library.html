<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">

    
        <title>Make a circle thumbnail with the Imagine PHP Image Library - adamcod.es</title>
    

    
    <meta name="description" content="A Filter for the Imagine PHP Image Library to create circle thumbnails">
    

    <meta name="author" content="Adam Brett">

    <!-- style -->
    <link rel="stylesheet" href="/css/style.css" type="text/css" media="screen, projection">

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" href="http://feeds.feedburner.com/adamcodes/">

    <!-- fonts -->
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:300,400" rel="stylesheet" type="text/css">
</head>
<body>
    <section class="layout-meta">
        <header>
            <p class="author vcard">
                <strong><a href="http://adamcod.es" rel="author">adamcod.es</a></strong><br />
                by <a href="http://adambrett.co.uk">Adam Brett</a>
            </p>
        </header>

        <nav>
            <ul>
                <!--li><a href="http://adambrett.co.uk/about">About</a></li-->
                <li><a href="/archive.html"><i class="icon-book"></i> Archive</a></li>
                <li><a href="http://feeds.feedburner.com/adamcodes/"><i class="icon-rss"></i> Subscribe</a></li>
                <li><a href="http://twitter.com/sixdaysad/"><i class="icon-twitter"></i> Contact</a></li>
            </ul>
        </nav>
    </section>

    <section class="layout-main">
        <article>
    <div class="instapaper_ignore entry-unrelated">

    <h1 class="entry-title"><a href="http://adamcod.es/2012/07/25/imagine-php-image-library.html">Make a circle thumbnail with the Imagine PHP Image Library</a></h1>
    <p class="meta"><time pubdate class="published" datetime="2012-07-25">Wednesday, July 25, 2012</time></p>
    <div class="twitter-button">
        
        <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://adamcod.es/2012/07/25/imagine-php-image-library.html" data-text="Make a circle thumbnail with the Imagine PHP Image Library by @sixdaysad">Tweet</a>
        
    </div>

    <div class="alert alert-warning">
  <h4>Out Of Date Warning</h4>

  <p>
    This article was published on <strong>Wednesday, July 25, 2012</strong> which was
    <strong>more than 12 months ago </strong>, this means the content may be
    out of date or no longer relevant.  You should <strong>verify that the
    technical information in this article is still current</strong> before
    relying upon it for your own purposes.
  </p>
</div>



    </div>

    <div class="entry-content">
        <h2 id="what-is-imagine">What is Imagine</h2>

<p>Image processing in PHP is <em>really</em> unpleasant.  Imagine is a PHP 5.3 library which makes image processing suck way less.  According to the <a href="http://imagine.readthedocs.org">documentation</a>:</p>

<blockquote>
  <p><a href="https://github.com/avalanche123/Imagine">Imagine</a> is a[n] OOP library for image manipulation built in PHP 5.3 using the latest best practices and thoughtful design that should allow for decoupled and unit-testable code.</p>
</blockquote>

<p>Put simply, Imagine is a nicely PSR-0 namespace’d wrapper that provides a consistent interface for lower level Gd, ImageMagick and GMagick functionality.  And <em>consistency is good</em>.</p>

<p>If you haven’t heard of Imagine, or aren’t familiar with its concepts, go <a href="https://speakerdeck.com/u/avalanche123/p/introduction-to-imagine">here</a> and read the presentation first, as the code below assumes a knowledge of its features concepts.</p>

<h2 id="the-problem">The Problem</h2>

<p>Whilst re-working an area of our internal CRM, we came up with the idea of cards.  These would be little snippets of information about people, companies, products and other CRM objects related to the page you’re on, neatly stacked in order of importance down the right-hand side of a page.</p>

<p>Here’s an initial concept for a contact card:</p>

<p><img src="/img/posts/contact-card-square.png" alt="Contact Card Square" /></p>

<p>Pretty good, but we decided we can do a bit bitter, and rounded pictures would be a bit friendlier:</p>

<p><img src="/img/posts/contact-card-face.png" alt="Contact Card Round" /></p>

<p>Only problem, that makes coding the thumbnails a lot harder.  Our users aren’t going to upload nice transparent rounded pictures for us, so we’re going to have to find a way to process them ourselves.</p>

<h2 id="enter-imagine">Enter Imagine</h2>

<p>Having read about Imagine, it had peaked my interested, and I’d wanted to use it on a project for a while.  It turns out that creating a circle thumbnail with Imagine is actually really easy.  Much like most custom things in Imagine, you want to create a filter, I called mine <code>CircleThumbnailFilter</code> (original, I know).  It looks like this:</p>

<div class="highlight"><pre><code class="php"><span id="True-1"><span class="cp">&lt;?php</span>
</span><span id="True-2"><span class="k">class</span> <span class="nc">CircleThumbnailFilter</span> <span class="k">implements</span> <span class="nx">Imagine\Filter\FilterInterface</span>
</span><span id="True-3"><span class="p">{</span>
</span><span id="True-4">    <span class="k">private</span> <span class="nv">$imagine</span><span class="p">;</span>
</span><span id="True-5">
</span><span id="True-6">    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nx">Imagine\Image\ImagineInterface</span> <span class="nv">$imagine</span><span class="p">,</span>
</span><span id="True-7">        <span class="nx">Imagine\Image\BoxInterface</span> <span class="nv">$size</span><span class="p">)</span>
</span><span id="True-8">    <span class="p">{</span>
</span><span id="True-9">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">imagine</span> <span class="o">=</span> <span class="nv">$imagine</span><span class="p">;</span>
</span><span id="True-10">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">size</span> <span class="o">=</span> <span class="nv">$size</span><span class="p">;</span>
</span><span id="True-11">    <span class="p">}</span>
</span><span id="True-12">
</span><span id="True-13">    <span class="k">public</span> <span class="k">function</span> <span class="nf">apply</span><span class="p">(</span><span class="nx">Imagine\Image\ImageInterface</span> <span class="nv">$image</span><span class="p">)</span>
</span><span id="True-14">    <span class="p">{</span>
</span><span id="True-15">        <span class="c1">// create a thumbnail</span>
</span><span id="True-16">        <span class="nv">$thumbnail</span> <span class="o">=</span> <span class="nv">$image</span><span class="o">-&gt;</span><span class="na">thumbnail</span><span class="p">(</span>
</span><span id="True-17">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">size</span><span class="p">,</span>
</span><span id="True-18">            <span class="nx">Imagine\Image\ImageInterface</span><span class="o">::</span><span class="na">THUMBNAIL_OUTBOUND</span>
</span><span id="True-19">        <span class="p">);</span>
</span><span id="True-20">
</span><span id="True-21">        <span class="c1">// create a new image to hold our mask</span>
</span><span id="True-22">        <span class="c1">// make the background white</span>
</span><span id="True-23">        <span class="nv">$mask</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">imagine</span><span class="o">-&gt;</span><span class="na">create</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">size</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Imagine\Image\Color</span><span class="p">(</span><span class="s1">&#39;fff&#39;</span><span class="p">));</span>
</span><span id="True-24">
</span><span id="True-25">        <span class="c1">// draw a black circle at the center of our new image</span>
</span><span id="True-26">        <span class="c1">// use $this-&gt;size to make it full width and height</span>
</span><span id="True-27">        <span class="nv">$mask</span><span class="o">-&gt;</span><span class="na">draw</span><span class="p">()</span>
</span><span id="True-28">            <span class="o">-&gt;</span><span class="na">ellipse</span><span class="p">(</span>
</span><span id="True-29">                <span class="k">new</span> <span class="nx">Imagine\Image\Point\Center</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">size</span><span class="p">),</span>
</span><span id="True-30">                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">size</span><span class="p">,</span>
</span><span id="True-31">                <span class="k">new</span> <span class="nx">Imagine\Image\Color</span><span class="p">(</span><span class="s1">&#39;000&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="True-32">                <span class="k">true</span>
</span><span id="True-33">            <span class="p">);</span>
</span><span id="True-34">
</span><span id="True-35">        <span class="c1">// apply the mask to the thumbnail and return it</span>
</span><span id="True-36">        <span class="k">return</span> <span class="nv">$thumbnail</span><span class="o">-&gt;</span><span class="na">applyMask</span><span class="p">(</span><span class="nv">$mask</span><span class="p">);</span>
</span><span id="True-37">    <span class="p">}</span>
</span><span id="True-38"><span class="p">}</span>
</span></code></pre></div>

<p>The constructor is fairly self explanatory, it takes an instance of your imagine interface, and a box instance which is used to control the size of your thumbnail.</p>

<p>The apply function is the one that does the work, it is required to take exactly one parameter, an instance of <code>Imagine\Image\ImageInterface</code> which is enforced by <code>Imagine\Filter\FilterInterface</code>.</p>

<p>The first thing we do is resize our image, if someone uploads a 1000x1000 image, we want to scale it down.</p>

<p>Next, we create a canvas and call it <code>$mask</code>.  We so this by calling the <code>create</code> method on the <code>ImageInterface</code> we passed to our constructor.  We pass in the <code>BoxInterface</code> we also passed to our constructor to tell it the size of the image we want to create, and a new <code>Imagine\Image\Color</code> to tell it the background colour we want.  We then end up with a brand-new instance of <code>Imagine\Image\ImageInterface</code> in <code>$mask</code>.</p>

<p>Next, we call the draw method on the image stored in $mask to load the <code>Drawer</code> object, and then we tell it to draw us an ellipse.</p>

<p>We first pass in the position we want the ellipse drawn at, which is the exact center of the Box we’ve been using all the way through, we tell it that we want our ellipse to be the same size as our box (i.e. to fill it), and we tell it to make it black, with no transparency, and finally we pass <code>true</code> which tells it that it should be filled, rather than an outline.</p>

<p>Once we have our mask created, if we were to save it, it would look something like this:</p>

<p><img src="/img/posts/contact-card-mask.png" alt="Contact Card Mask" /></p>

<p>We don’t want to output our mask though, we just want to use it to make parts of our square thumbnail transparent.  To do that we use Imagine’s built-in applyMask filter, passing the mask we created earlier in as the only parameter.  We can then return this image so we can use it in our scripts.</p>

<h2 id="usage">Usage</h2>

<p>To use the filter, you need to include Imagine using <a href="http://imagine.readthedocs.org/en/latest/usage/introduction.html#installation">one of the methods in the documentation</a>, I recommend installing it via <a href="http://getcomposer.org">composer</a>, as Imagine is available on <a href="http://packagist.org/packages/imagine/Imagine">packagist</a>, and then using the composer autoloader to load Imagine via the PSR-0 namespace syntax.</p>

<p>You will also need to autoload or require the CircleThumbnailFilter object somehow, you could put it in your app’s namespace or just do it the old-school way with <code>require_once</code>.  Either way, when both are loaded, you can run the circle filter like so:</p>

<div class="highlight"><pre><code class="php"><span id="True-1"><span class="cp">&lt;?php</span>
</span><span id="True-2">
</span><span id="True-3"><span class="nv">$imagine</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Imagine\Gd\Imagine</span><span class="p">();</span>
</span><span id="True-4"><span class="nv">$filter</span>  <span class="o">=</span> <span class="k">new</span> <span class="nx">CircleThumbnailFilter</span><span class="p">(</span><span class="nv">$imagine</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Imagine\Image\Box</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">));</span>
</span><span id="True-5">
</span><span id="True-6"><span class="nv">$filter</span><span class="o">-&gt;</span><span class="na">apply</span><span class="p">(</span><span class="nv">$imagine</span><span class="o">-&gt;</span><span class="na">open</span><span class="p">(</span><span class="s1">&#39;/path/to/square/image.jpg&#39;</span><span class="p">))</span>
</span><span id="True-7">    <span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="s1">&#39;/path/to/circle/image.png&#39;</span><span class="p">);</span>
</span></code></pre></div>

<p>Make sure that no-matter what your input format (which isn’t really important, Imagine should know what to do with most valid image formats), make sure you output it as something with transparency (preferably png).  Don’t do what I did and spend 40 minutes wondering why the transparency mask wasn’t applying when you were outputting as a jpg.</p>

    </div>

    <section>
        <form class="well form-inline text-center" action="https://tinyletter.com/adambrett" method="post" target="popupwindow" onsubmit="window.open('https://tinyletter.com/adambrett', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true">
    <p>For more exclusive content, including screen-casts, videos, and early beta access to my projects, subscribe to my email list below.</p>
    <p>
        <input type="text" name="email" placeholder="Enter your email address" /> <input type="submit" value="Subscribe" class="btn btn-primary" />
    </p>

    <input type="hidden" value="1" name="embed"/>
</form>

    </section>

    <hr>

    <footer>
        <p><small>I love discussion, but not blog comments.  If you want to comment on what's written above, head over to <a href="https://twitter.com/sixdaysad">twitter</a> or <a href="https://alpha.app.net/adambrett">ADN</a>.</small></p>
    </footer>
</article>


<hr>

<ul class="pager">
    
    <li class="previous">
        <a href="/2012/07/17/cakephp-class-string-not-found.html">&larr; Previous</a>
    </li>
    

    
    <li class="next">
        <a href="/2012/08/03/git-cleanly-move-between-branches.html">Next &rarr;</a>
    </li>
    
</ul>


        <footer>
            <p>Copyright &copy; 2012 <a href="http://adambrett.co.uk">Adam Brett</a>.  All rights reserved.</p>
        </footer>
    </section>

    <script>
        (function () {
            var images = document.getElementsByTagName('img');
            for (var i = 0; i < images.length; i++) {
                images[i].style.height = (Math.ceil(images[i].clientHeight/26) * 26) + 'px';
            }
        })();
    </script>
    <script src="http://platform.twitter.com/widgets.js?ver=1.1"></script>
    <script>
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-10572636-6']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
</body>
</html>
