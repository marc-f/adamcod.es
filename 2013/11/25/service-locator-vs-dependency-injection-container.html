<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">

    
        <title>Service Locator vs Dependency Injection Container (or Tell, Don't Ask Part 2) - adamcod.es</title>
    

    

    <meta name="author" content="Adam Brett">

    <!-- style -->
    <link rel="stylesheet" href="/css/style.css" type="text/css" media="screen, projection">

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" href="http://feeds.feedburner.com/adamcodes/">

    <!-- fonts -->
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:300,400" rel="stylesheet" type="text/css">
</head>
<body>
    <section class="layout-meta">
        <header>
            <p class="author vcard">
                <strong><a href="http://adamcod.es" rel="author">adamcod.es</a></strong><br />
                by <a href="http://adambrett.co.uk">Adam Brett</a>
            </p>
        </header>

        <nav>
            <ul>
                <!--li><a href="http://adambrett.co.uk/about">About</a></li-->
                <li><a href="/archive.html"><i class="icon-book"></i> Archive</a></li>
                <li><a href="http://feeds.feedburner.com/adamcodes/"><i class="icon-rss"></i> Subscribe</a></li>
                <li><a href="http://twitter.com/sixdaysad/"><i class="icon-twitter"></i> Contact</a></li>
            </ul>
        </nav>
    </section>

    <section class="layout-main">
        <article>
    <div class="instapaper_ignore entry-unrelated">

    <h1 class="entry-title"><a href="http://adamcod.es/2013/11/25/service-locator-vs-dependency-injection-container.html">Service Locator vs Dependency Injection Container (or Tell, Don't Ask Part 2)</a></h1>
    <p class="meta"><time pubdate class="published" datetime="2013-11-25">Monday, November 25, 2013</time></p>
    <div class="twitter-button">
        
        <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://adamcod.es/2013/11/25/service-locator-vs-dependency-injection-container.html" data-text="Service Locator vs Dependency Injection Container (or Tell, Don't Ask Part 2) by @sixdaysad">Tweet</a>
        
    </div>

    


    </div>

    <div class="entry-content">
        <p>Last week I wrote about <a href="/2013/11/22/tell-dont-ask.html">Tell Don’t Ask</a> type code smells and why you should avoid them.  Tell Don’t Ask is also present in another more wide-spread form: Service Locators.</p>

<p>Dependency Injection is a hot topic in web development, and all of the current generation frameworks have some sort of Dependency Injection Container to attempt to simplify this for you.  The idea behind the Dependency Injection Container is that it knows how to create all of your objects and their dependencies, so you can easily get an object with all of its dependencies with one simple call.  Let’s take a look at an example:</p>

<div class="highlight"><pre><code class="php"><span class="k">class</span> <span class="nc">ExampleController</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$request</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$response</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__constructor</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExampleRequest</span><span class="p">(</span><span class="nv">$_GLOBALS</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">response</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExampleResponse</span><span class="p">(</span><span class="k">new</span> <span class="nx">ExampleView</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$router</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExampleRouter</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">);</span>

<span class="nb">call_user_func_array</span><span class="p">(</span>
    <span class="p">[</span><span class="k">new</span> <span class="nv">$router</span><span class="o">-&gt;</span><span class="na">getControllerName</span><span class="p">(),</span> <span class="nv">$router</span><span class="o">-&gt;</span><span class="na">getActionName</span><span class="p">()],</span>
    <span class="nv">$router</span><span class="o">-&gt;</span><span class="na">getParams</span><span class="p">()</span>
<span class="p">);</span>
</code></pre></div>

<p>This is a fairly typical, if somewhat simplified and fictitious controller and dispatch process for a 2006 era framework.  Objects were created when a class was constructed, and little if anything was injected.</p>

<p>Current generation frameworks have learnt a great deal, and the above would now be more likely to be injected in some form, maybe something like this:</p>

<div class="highlight"><pre><code class="php"><span class="k">class</span> <span class="nc">ExampleController</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$request</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$response</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__constructor</span><span class="p">(</span><span class="nx">ExampleContainer</span> <span class="nv">$container</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span> <span class="o">=</span> <span class="nv">$container</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">response</span> <span class="o">=</span> <span class="nv">$container</span><span class="o">-&gt;</span><span class="na">response</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$container</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExampleContainer</span><span class="p">();</span>

<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">request</span> <span class="o">=</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">ExampleRequest</span><span class="p">(</span><span class="nv">$_GLOBALS</span><span class="p">);</span>
<span class="p">};</span>

<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">router</span> <span class="o">=</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">ExampleRouter</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">);</span>
<span class="p">}</span>

<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">view</span> <span class="o">=</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">ExampleView</span><span class="p">();</span>
<span class="p">}</span>

<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">response</span> <span class="o">=</span> <span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$container</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">ExampleResponse</span><span class="p">(</span><span class="nv">$container</span><span class="p">);</span>
<span class="p">}</span>

<span class="nv">$router</span> <span class="o">=</span> <span class="nv">$container</span><span class="o">-&gt;</span><span class="na">router</span><span class="p">();</span>
<span class="nv">$controller</span> <span class="o">=</span> <span class="nv">$router</span><span class="o">-&gt;</span><span class="na">getController</span><span class="p">();</span>

<span class="nb">call_user_func_array</span><span class="p">(</span>
    <span class="p">[</span><span class="k">new</span> <span class="nv">$controller</span><span class="p">(</span><span class="nv">$container</span><span class="p">),</span> <span class="nv">$router</span><span class="o">-&gt;</span><span class="na">getActionName</span><span class="p">()],</span>
    <span class="nv">$router</span><span class="o">-&gt;</span><span class="na">getParams</span><span class="p">()</span>
<span class="p">);</span>
</code></pre></div>

<p>Uh oh!  Did you spot the code smell?  That’s right, we’re asking our container for the request and response, instead of telling it what request and response to use, and that’s a violation of Tell Don’t Ask.</p>

<h2 id="whats-the-difference">What’s the Difference?</h2>

<p>I’m covering this here and now, because when I explain away the above code-smell it’s important you understand the distinction between the two.  I have searched The Internet quite a bit for a definitive answer to the question <em>what’s the difference between a service locator and a dependency injection container?</em> and turned up a whole bunch of Stack Overflow answers and blog posts which gave similar wishy-washy, contradictory or uncertain answers.</p>

<p>I’m going to stick my neck on the line and give a definitive answer: <strong>There is no difference between a Service Locator and a Dependency Injection Container</strong>, at least in terms of how they are implemented.</p>

<p>The bottom line is, <strong>the difference between a Service Locator, and a Dependency Injection Container is how you consume them</strong>.  The implementation of both can be identical, but with a Service Locator you inject the container and <em>ask</em> it for the object you want, whereas with a Dependency Injection Container you use it to construct objects, but a Dependency Injection Container should only ever call itself, and never be called by any other objects.</p>

<p>In other words, your application is aware it’s using a Service Locator, but your application should be totally un-aware that it’s using a Dependency Injection Container.</p>

<p>Looking at our above code example, that code is using <code>$container</code> as a Service Locator.  It’s expecting it to be injected, then <em>asking</em> it for the Request and Response Objects.</p>

<p>We can re-write our example to use our container object as a Dependency Injection Container with some very small changes:</p>

<div class="highlight"><pre><code class="php"><span class="k">class</span> <span class="nc">ExampleController</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$request</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$response</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__constructor</span><span class="p">(</span><span class="nx">ExampleRequest</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">ExampleResponse</span> <span class="nv">$response</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span> <span class="o">=</span> <span class="nv">$request</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">response</span> <span class="o">=</span> <span class="nv">$response</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$container</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExampleContainer</span><span class="p">();</span>

<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">request</span> <span class="o">=</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">ExampleRequest</span><span class="p">(</span><span class="nv">$_GLOBALS</span><span class="p">);</span>
<span class="p">};</span>

<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">router</span> <span class="o">=</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">ExampleRouter</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">);</span>
<span class="p">}</span>

<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">view</span> <span class="o">=</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">ExampleView</span><span class="p">();</span>
<span class="p">}</span>

<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">response</span> <span class="o">=</span> <span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$container</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">ExampleResponse</span><span class="p">(</span><span class="nv">$container</span><span class="o">-&gt;</span><span class="na">view</span><span class="p">());</span>
<span class="p">}</span>

<span class="nv">$router</span> <span class="o">=</span> <span class="nv">$container</span><span class="o">-&gt;</span><span class="na">router</span><span class="p">();</span>
<span class="nv">$controllerName</span> <span class="o">=</span> <span class="nv">$router</span><span class="o">-&gt;</span><span class="na">getController</span><span class="p">();</span>
<span class="nv">$controller</span> <span class="o">=</span> <span class="k">new</span> <span class="nv">$controllerName</span><span class="p">(</span><span class="nv">$container</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(),</span> <span class="nv">$container</span><span class="o">-&gt;</span><span class="na">response</span><span class="p">());</span>

<span class="nb">call_user_func_array</span><span class="p">(</span>
    <span class="p">[</span><span class="nv">$controller</span><span class="p">,</span> <span class="nv">$container</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">router</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getActionName</span><span class="p">()],</span>
    <span class="nv">$container</span><span class="o">-&gt;</span><span class="na">router</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getParams</span><span class="p">()</span>
<span class="p">);</span>
</code></pre></div>

<p>See, this is now a Dependency Injection Container, not a Service Locator, but the implementation hasn’t changed at all.  People have such a hard time telling the difference between the two because they’re really the same thing.  The only distinction is that one is used in a way that violates the Tell, Don’t Ask principle, and the other is not.</p>

<h2 id="why-bother">Why Bother?</h2>

<p>So, why use a container at all, why not just use straight up dependency injection?  Well, you can, but the point of a dependency injection container <em>for your application</em> (n.b. you should never use a container in library code) is for complex dependency graphs.  In our very simple and trivial example we’re constructing the <code>ExampleController</code>, which requires the <code>ExampleResponse</code> object which then depends on the <code>ExampleView</code> object. Now imagine <code>ExampleView</code> depends on <code>ExampleCache</code> and <code>ExampleTwigAdapter</code>, which each in turn depend on <code>ExampleFileCache</code> and <code>Twig</code> itself.  Let’s take a look at that example using regular old Dependency Injection:</p>

<div class="highlight"><pre><code class="php"><span class="nv">$request</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExampleRequest</span><span class="p">(</span><span class="nv">$_GLOBALS</span><span class="p">);</span>
<span class="nv">$router</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExampleRouter</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">);</span>
<span class="nv">$fileAdapter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExampleFileCache</span><span class="p">();</span>
<span class="nv">$cache</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExampleCache</span><span class="p">(</span><span class="nv">$fileAdapter</span><span class="p">);</span>
<span class="nv">$twig</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">();</span>
<span class="nv">$twigAdapter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExampleTwigAdapter</span><span class="p">(</span><span class="nv">$twig</span><span class="p">);</span>
<span class="nv">$view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExampleView</span><span class="p">(</span><span class="nv">$cache</span><span class="p">,</span> <span class="nv">$twigAdapter</span><span class="p">);</span>
<span class="nv">$response</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExampleResponse</span><span class="p">(</span><span class="nv">$view</span><span class="p">);</span>
<span class="nv">$controller</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExampleController</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="nv">$response</span><span class="p">);</span>
</code></pre></div>

<p>That’s a whole lot of objects to create every time you want to create a controller.  Sure, you could shorten it by not creating the variables and injecting the new objects directly, but that doesn’t save you much:</p>

<div class="highlight"><pre><code class="php"><span class="nv">$router</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExampleRouter</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">);</span>
<span class="nv">$controller</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExampleController</span><span class="p">(</span>
    <span class="k">new</span> <span class="nx">ExampleRequest</span><span class="p">(</span><span class="nv">$_GLOBALS</span><span class="p">),</span>
    <span class="k">new</span> <span class="nx">ExampleResponse</span><span class="p">(</span>
        <span class="k">new</span> <span class="nx">ExampleView</span><span class="p">(</span>
            <span class="k">new</span> <span class="nx">ExampleCache</span><span class="p">(</span>
                <span class="k">new</span> <span class="nx">ExampleFileCache</span><span class="p">()</span>
            <span class="p">),</span>
            <span class="k">new</span> <span class="nx">ExampleTwigAdapter</span><span class="p">(</span>
                <span class="k">new</span> <span class="nx">Twig</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">);</span>
</code></pre></div>

<p>You might think that’s not too bad, but imagine you’ve created a new cache object in 5 or 6 different places and then want to update it to use <code>ExampleMemcache</code>.  With a Dependency Injection Container you only create your objects in one place, so you only ever need to update them in one place:</p>

<div class="highlight"><pre><code class="php"><span class="nv">$container</span><span class="o">-&gt;</span><span class="na">cacheAdapter</span> <span class="o">=</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">ExampleFileCache</span><span class="p">();</span>
<span class="p">};</span>

<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">cache</span> <span class="o">=</span> <span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$container</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">ExampleCache</span><span class="p">(</span><span class="nv">$container</span><span class="o">-&gt;</span><span class="na">cacheAdapter</span><span class="p">());</span>
<span class="p">};</span>
</code></pre></div>

<p>Becomes:</p>

<div class="highlight"><pre><code class="php"><span class="nv">$container</span><span class="o">-&gt;</span><span class="na">cacheAdapter</span> <span class="o">=</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">ExampleMemcache</span><span class="p">();</span>
<span class="p">};</span>

<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">cache</span> <span class="o">=</span> <span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$container</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">ExampleCache</span><span class="p">(</span><span class="nv">$container</span><span class="o">-&gt;</span><span class="na">cacheAdapter</span><span class="p">());</span>
<span class="p">};</span>
</code></pre></div>

<p>And our application gets updated everywhere the cache is injected.  Awesome.  But the Dependency Injection Container has another added benefit, because all of our object construction is pre-defined, constructing our previously complicated controller becomes as simple as:</p>

<div class="highlight"><pre><code class="php"><span class="k">new</span> <span class="nx">ExampleController</span><span class="p">(</span><span class="nv">$container</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(),</span> <span class="nv">$container</span><span class="o">-&gt;</span><span class="na">response</span><span class="p">());</span>
</code></pre></div>

<p>Our container then knows what dependencies <code>ExampleRequest</code> and <code>ExampleResponse</code> are expecting, and in turn the dependencies of those objects and so on and so forth.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Lots of people call Service Locator an anti-pattern, mostly because it hides your dependency graph away, and whilst it’s true, it does, the same could also be argued (although less so) about Dependency Injection Containers.</p>

<p>The most important downside of a Service Locator is the violation of the Tell, Don’t Ask principle, and <a href="/2013/11/22/tell-dont-ask.html">as I said last week</a>, due to the tight coupling that it introduces, violation of Tell, Don’t Ask can often be fatal, and that’s why you should probably avoid it in your next application.</p>

<h2 id="read-next">Read Next:</h2>

<ul>
  <li><a href="/2013/11/22/tell-dont-ask.html">Tell, Don’t Ask</a></li>
</ul>

    </div>

    <section>
        <form class="well form-inline text-center" action="https://tinyletter.com/adambrett" method="post" target="popupwindow" onsubmit="window.open('https://tinyletter.com/adambrett', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true">
    <p>For more exclusive content, including screen-casts, videos, and early beta access to my projects, subscribe to my email list below.</p>
    <p>
        <input type="text" name="email" placeholder="Enter your email address" /> <input type="submit" value="Subscribe" class="btn btn-primary" />
    </p>

    <input type="hidden" value="1" name="embed"/>
</form>

    </section>

    <hr>

    <footer>
        <p><small>I love discussion, but not blog comments.  If you want to comment on what's written above, head over to <a href="https://twitter.com/sixdaysad">twitter</a> or <a href="https://alpha.app.net/adambrett">ADN</a>.</small></p>
    </footer>
</article>


<hr>

<ul class="pager">
    
    <li class="previous">
        <a href="/2013/11/22/tell-dont-ask.html">&larr; Previous</a>
    </li>
    

    
</ul>


        <footer>
            <p>Copyright &copy; 2012 <a href="http://adambrett.co.uk">Adam Brett</a>.  All rights reserved.</p>
        </footer>
    </section>

    <script>
        function setImageHeight() {
          var baseLine = 26, img, _i, _len, _ref, _results;
          _ref = document.getElementsByTagName('img');
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            img = _ref[_i];
            _results.push(img.style.height = Math.ceil(img.clientHeight / baseLine) * baseLine + "px");
          }
          return _results;
        }

        if (window.addEventListener) {
          window.addEventListener('load', setImageHeight, false);
        } else if (window.attachEvent)  {
          window.attachEvent('onload', setImageHeight);
        }
    </script>
    <script src="http://platform.twitter.com/widgets.js?ver=1.1"></script>
    <script>
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-10572636-6']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        // ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
</body>
</html>
