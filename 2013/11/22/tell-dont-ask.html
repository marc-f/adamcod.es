<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">

    
        <title>Tell, Don't Ask - adamcod.es</title>
    

    

    <meta name="author" content="Adam Brett">

    <!-- style -->
    <link rel="stylesheet" href="/css/style.css" type="text/css" media="screen, projection">

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" href="http://feeds.feedburner.com/adamcodes/">

    <!-- fonts -->
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:300,400" rel="stylesheet" type="text/css">
</head>
<body>
    <section class="layout-meta">
        <header>
            <p class="author vcard">
                <strong><a href="http://adamcod.es" rel="author">adamcod.es</a></strong><br />
                by <a href="http://adambrett.co.uk">Adam Brett</a>
            </p>
        </header>

        <nav>
            <ul>
                <!--li><a href="http://adambrett.co.uk/about">About</a></li-->
                <li><a href="/archive.html"><i class="icon-book"></i> Archive</a></li>
                <li><a href="http://feeds.feedburner.com/adamcodes/"><i class="icon-rss"></i> Subscribe</a></li>
                <li><a href="http://twitter.com/sixdaysad/"><i class="icon-twitter"></i> Contact</a></li>
            </ul>
        </nav>
    </section>

    <section class="layout-main">
        <article>
    <div class="instapaper_ignore entry-unrelated">

    <h1 class="entry-title"><a href="http://adamcod.es/2013/11/22/tell-dont-ask.html">Tell, Don't Ask</a></h1>
    <p class="meta"><time pubdate class="published" datetime="2013-11-22">Friday, November 22, 2013</time></p>
    <div class="twitter-button">
        
        <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://adamcod.es/2013/11/22/tell-dont-ask.html" data-text="Tell, Don't Ask by @sixdaysad">Tweet</a>
        
    </div>

    


    </div>

    <div class="entry-content">
        <p>Violation of the Tell, Don’t Ask principle is one of the most common mistakes I see in legacy code-bases, and one of the most common mistakes I see in new code that I review.  Left unchecked it can lead to serious problems down the line.</p>

<p>Here’s an example:</p>

<div class="highlight"><pre><code class="php"><span class="k">class</span> <span class="nc">ExampleForm</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="no">SELECT</span> <span class="o">=</span> <span class="s1">&#39;&lt;select name=&quot;%s&quot;&gt;%s&lt;/select&gt;&#39;</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">OPTION</span> <span class="o">=</span> <span class="s1">&#39;&lt;option value=&quot;%s&quot;&gt;%s&lt;/option&gt;&#39;</span><span class="p">;</span>

    <span class="k">protected</span> <span class="nv">$mapper</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nx">ExampleMapper</span> <span class="nv">$mapper</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mapper</span> <span class="o">=</span> <span class="nv">$mapper</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// ...snip...</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getExampleSelect</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$options</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mapper</span><span class="o">-&gt;</span><span class="na">fetchList</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$id</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$options</span><span class="p">[]</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">OPTION</span><span class="p">,</span> <span class="nv">$id</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nb">sprintf</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">SELECT</span><span class="p">,</span> <span class="s1">&#39;someSelect&#39;</span><span class="p">,</span> <span class="nb">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">$options</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$someForm</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExampleForm</span><span class="p">(</span><span class="nv">$mapper</span><span class="p">);</span>
<span class="k">echo</span> <span class="nv">$someForm</span><span class="o">-&gt;</span><span class="na">getExampleSelect</span><span class="p">();</span>
</code></pre></div>

<p>On the face of it, this code is actually pretty good.  It’s some sort of form class, and the <code>getExampleSelect</code> method is building up an HTML select element.  The mapper was injected, meaning the code is pretty easy to test, as we can replace the mapper with a mock object.</p>

<p>There is a problem, however, and the problem is a fundamental one.  Left unchecked, this problem can grow and fester with your software.  Over time it can cause your development pace to slow to the point adding even trivial new features or changes to existing code can take weeks or months, slowing development velocity to a crawl, or stalling it altogether.</p>

<p>The problem with the above code, which may not be obvious at first, is the <code>getExampleSelect</code> method <em>asking</em> the mapper for a list to iterate over. By injecting the mapper and then <em>asking</em> it for the list we are tying the implementation of that form not only to the mapper, but also the implementation of the mapper.</p>

<p>This means that in 6 months, 12 months, or even (as in the case at my current employment) 8 years later, you want to create an instance of <code>ExampleForm</code> that specifies the list options manually, rather than relying on the mapper, you have very few options to re-use this form class.  You can either sub-class it, or you can hack <code>$mapper-&gt;fetchList()</code> to return different things, adding in some sort of flag depending on the situation.</p>

<p>Over time this can grow and lead to a mess of sub-classes and hacky code with cryptic flags that anyone who has maintained a large enough legacy application has seen hundreds of times before.</p>

<p>Taking a step back and looking at this code objectively, does your form really need to know about the mapper?  Does it really care <em>where</em> that list comes from, or does it just care about the list itself?  Really all it needs is the list, so how about if we re-wrote it, something like this:</p>

<div class="highlight"><pre><code class="php"><span class="k">class</span> <span class="nc">ExampleForm</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="no">SELECT</span> <span class="o">=</span> <span class="s1">&#39;&lt;select name=&quot;%s&quot;&gt;%s&lt;/select&gt;&#39;</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">OPTION</span> <span class="o">=</span> <span class="s1">&#39;&lt;option value=&quot;%s&quot;&gt;%s&lt;/option&gt;&#39;</span><span class="p">;</span>

    <span class="k">protected</span> <span class="nv">$exampleList</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nx">ExampleList</span> <span class="nv">$exampleList</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">exampleList</span> <span class="o">=</span> <span class="nv">$exampleList</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// ...snip...</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getExampleSelect</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$options</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">exampleList</span> <span class="k">as</span> <span class="nv">$id</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$options</span><span class="p">[]</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">OPTION</span><span class="p">,</span> <span class="nv">$id</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nb">sprintf</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">SELECT</span><span class="p">,</span> <span class="s1">&#39;someSelect&#39;</span><span class="p">,</span> <span class="nb">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">$options</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$someForm</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExampleForm</span><span class="p">(</span><span class="nv">$mapper</span><span class="o">-&gt;</span><span class="na">fetchList</span><span class="p">());</span>
<span class="k">echo</span> <span class="nv">$someForm</span><span class="o">-&gt;</span><span class="na">getExampleSelect</span><span class="p">();</span>
</code></pre></div>

<p>The change here is a very subtle, but very fundamental one.  As our form object doesn’t ever need to know where its list is coming from, just that it receives it, our form has suddenly become a whole lot more flexible.</p>

<p>By telling the form upfront that we want it to use <em>this</em> list, the implementation doesn’t ever need to change, as the form doesn’t care <em>where</em> that list comes from, as long as it is always there.</p>

<h2 id="feature-envy">Feature Envy</h2>

<p>Feature Envy<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup> is when one class uses a lot of the methods of another class, or a class performs actions on and changes the internal state of another object.  Tell, Don’t Ask can be used to avoid this type of code-smell.  Here is another example that illustrates this type of problem:</p>

<div class="highlight"><pre><code class="php"><span class="k">class</span> <span class="nc">IssueTracker</span>
<span class="p">{</span>
    <span class="c1">// ... snip ...</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">closeBug</span><span class="p">(</span><span class="nv">$bug</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">isFixed</span><span class="p">())</span> <span class="p">{</span>
            <span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">setStatus</span><span class="p">(</span><span class="s1">&#39;closed&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>This example is a less obvious Tell, Don’t Ask type code-smell, but because we’re asking the object about its state and then altering it based on the result, it does qualify.  Inside the object itself this wouldn’t be a problem, but outside of the object it’s indicative of Feature Envy.</p>

<p>An object should always be responsible for altering its own state, so the above should be rewritten as:</p>

<div class="highlight"><pre><code class="php"><span class="k">class</span> <span class="nc">IssueTracker</span>
<span class="p">{</span>
    <span class="c1">// ... snip ...</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">closeBug</span><span class="p">(</span><span class="nv">$bug</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$bug</span><span class="o">-&gt;</span><span class="na">close</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Bug</span>
<span class="p">{</span>
    <span class="c1">// ... snip ...</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">close</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isFixed</span><span class="p">())</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setStatus</span><span class="p">(</span><span class="s1">&#39;closed&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">setStatus</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<p>This changes our <code>IssueTracker</code> so that is tells the bug to close, rather than asking the bug for its state and altering it based on the result.</p>

<p>This also encapsulates the domain logic for the <code>Bug</code> entity (i.e. that it cannot be closed unless it is fixed) inside the <code>Bug</code> object.  This means that whenever a <code>Bug</code> object is created it can never enter an invalid state, because the public interface won’t allow it, the decision is always made by the <code>Bug</code> itself, and never the object that’s calling it.</p>

<h2 id="exceptions">Exceptions</h2>

<p>As with all rules, there are exceptions to Tell, Don’t Ask.  The most obvious of which is the Parameter Object<sup id="fnref:2"><a href="#fn:2" class="footnote">2</a></sup>.</p>

<p>Consider the following example:</p>

<div class="highlight"><pre><code class="php"><span class="k">class</span> <span class="nc">ExampleMapper</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">store</span><span class="p">(</span><span class="nx">ExampleEntity</span> <span class="nv">$entity</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">gateway</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">([</span>
            <span class="nv">$entity</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">(),</span>
            <span class="nv">$entity</span><span class="o">-&gt;</span><span class="na">getValue</span><span class="p">(),</span>
        <span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Here, we’re treating our Entity as a Parameter Object, and  <em>asking</em> it for its values, rather than <em>telling</em> the mapper what values to use.  In this instance, it is an acceptable trade-off, as the entity shouldn’t know that it’s persisted, as some types of entities may never be stored anywhere (e.g. an <code>InMemoryEntity</code>), so it doesn’t make sense to have a <code>store</code> method on the entity. Also, because an entity could evolve over time our method signature could be constantly evolving, or an entity could have a large number of properties that would be inconvenient to specify manually.</p>

<h2 id="conclusion">Conclusion</h2>

<p>If you’re already doing Dependency Injection, Tell Don’t Ask is going to be one of the most powerful tools you have for writing code that is as flexible and de-coupled as possible.  Add it to the things you check for in code-reviews, teach it to your junior developers, and make sure you refactor it away whenever you spot it in legacy code.</p>

<h2 id="read-next">Read Next:</h2>

<ul>
  <li><a href="/2013/09/27/function-method-procedure.html">Function vs Method vs Procedure</a></li>
</ul>

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>http://c2.com/cgi/wiki?FeatureEnvySmell<a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:2">
      <p>http://c2.com/cgi/wiki?ParameterObject<a href="#fnref:2" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

    </div>

    <section>
        <form class="well form-inline text-center" action="https://tinyletter.com/adambrett" method="post" target="popupwindow" onsubmit="window.open('https://tinyletter.com/adambrett', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true">
    <p>For more exclusive content, including screen-casts, videos, and early beta access to my projects, subscribe to my email list below.</p>
    <p>
        <input type="text" name="email" placeholder="Enter your email address" /> <input type="submit" value="Subscribe" class="btn btn-primary" />
    </p>

    <input type="hidden" value="1" name="embed"/>
</form>

    </section>

    <hr>

    <footer>
        <p><small>I love discussion, but not blog comments.  If you want to comment on what's written above, head over to <a href="https://twitter.com/sixdaysad">twitter</a> or <a href="https://alpha.app.net/adambrett">ADN</a>.</small></p>
    </footer>
</article>


<hr>

<ul class="pager">
    
    <li class="previous">
        <a href="/2013/09/27/function-method-procedure.html">&larr; Previous</a>
    </li>
    

    
    <li class="next">
        <a href="/2013/11/25/service-locator-vs-dependency-injection-container.html">Next &rarr;</a>
    </li>
    
</ul>


        <footer>
            <p>Copyright &copy; 2012 <a href="http://adambrett.co.uk">Adam Brett</a>.  All rights reserved.</p>
        </footer>
    </section>

    <script>
        function setImageHeight() {
          var baseLine = 26, img, _i, _len, _ref, _results;
          _ref = document.getElementsByTagName('img');
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            img = _ref[_i];
            _results.push(img.style.height = Math.ceil(img.clientHeight / baseLine) * baseLine + "px");
          }
          return _results;
        }

        if (window.addEventListener) {
          window.addEventListener('load', setImageHeight, false);
        } else if (window.attachEvent)  {
          window.attachEvent('onload', setImageHeight);
        }
    </script>
    <script src="http://platform.twitter.com/widgets.js?ver=1.1"></script>
    <script>
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-10572636-6']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        // ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
</body>
</html>
