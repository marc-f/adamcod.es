<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">

    
        <title>Vagrant is easy - Chef is hard (Part 2). - adamcod.es</title>
    

    

    <meta name="author" content="Adam Brett">

    <!-- style -->
    <link rel="stylesheet" href="/css/style.css" type="text/css" media="screen, projection">

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" href="http://feeds.feedburner.com/adamcodes/">

    <!-- fonts -->
    <link href="http://fonts.googleapis.com/css?family=Cardo|Open+Sans" rel="stylesheet" type="text/css">

    <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>
<body>
    <section class="layout-meta">
        <header>
            <p class="author vcard">
                <strong><a href="http://adamcod.es" rel="author">adamcod.es</a></strong><br />
                by <a href="http://adambrett.co.uk">Adam Brett</a>
            </p>
        </header>

        <nav>
            <ul>
                <!--li><a href="http://adambrett.co.uk/about">About</a></li-->
                <li><a href="/archive.html"><i class="icon-book"></i> Archive</a></li>
                <li><a href="http://feeds.feedburner.com/adamcodes/"><i class="icon-rss"></i> Subscribe</a></li>
                <li><a href="http://twitter.com/sixdaysad/"><i class="icon-twitter"></i> Contact</a></li>
            </ul>
        </nav>
    </section>

    <section class="layout-main">
        <article>
    <div class="instapaper_ignore entry-unrelated">

    <h1 class="entry-title"><a href="http://adamcod.es/2013/01/15/vagrant-is-easy-chef-is-hard-part2.html">Vagrant is easy - Chef is hard (Part 2).</a></h1>
    <p class="meta"><time pubdate class="published" datetime="2013-01-15">Tuesday, January 15, 2013</time></p>
    <div class="twitter-button"><a href="https://twitter.com/share" class="twitter-share-button" data-url="http://adamcod.es/2013/01/15/vagrant-is-easy-chef-is-hard-part2.html" data-text="Vagrant is easy - Chef is hard (Part 2). by @sixdaysad">Tweet</a></div>


    </div>

    <div class="entry-content">
        <p>This is part 2 of a 2 part quick-start to using Vagrant<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup> and Chef<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup> to speed up and simplify your development environment.  If you haven’t read the first part, and aren’t already familiar with Vagrant go to <a href="/2013/01/15/vagrant-is-easy-chef-is-hard.html">part 1 here</a>.</p>

<p>In part 1 we covered the key commands and config settings you need to get vagrant up and running quickly with little-to-no fuss.  But that was the easy part.  Now comes the hard part.  Chef.</p>

<h2 id="chef">Chef</h2>

<p>The reason Chef is so hard, and the reason it has such as steep learning curve, is that every single blog post or tutorial, and even the chef manual itself, all deal with low-level Chef.  That is not what we want.  As a developer I have a hundred things to do and no time to do them.  I don’t care about low-level stuff.  I want stuff that Just Works.  So here we go.  This is the least amount of knowledge you need to get a lamp stack up and running on Vagrant.  As a side effect of that, you’ll actually learn quite a bit of Chef along the way.</p>

<h3 id="key-points">Key Points</h3>

<p>Before we start, there are a couple of key definitions you’re going to need to learn to make your life simpler.  They aren’t difficult, and I’ll do my best to distil them down to a basic level.</p>

<h4 id="cookbooks">Cookbooks</h4>

<p>Installing things (apache, mysql, php etc) is done by something called Cookbooks.  Cookbooks are a collection of Templates and <em>Recipes</em> (and a few other things we don’t care about right now) that  tell Chef how to install something.</p>

<h5 id="recipes">Recipes</h5>

<p>At a basic level, a <em>Recipe</em> is a ruby file that calls a bunch of Chef functions to install something.</p>

<h5 id="templates">Templates</h5>

<p>A template is much like a PHP app template with variable replacements, loops etc, but for system config files.  Think v-hosts, httpd.conf, php.ini etc.</p>

<h5 id="lwrp">LWRP</h5>

<p>You will see LWRPs mentioned a lot and it’s not immediately obvious what they are.  It stands for <em>Light Weight Resource Providers</em>.  But really they’re functions that do something Chefy (like install a Pecl Module/PEAR Library in the PHP Cookbook).  They should just call them that.  You don’t really need to use these yet, but I figured you’d want to know what they are when you see them mentioned elsewhere.</p>

<h4 id="chef-server-vs-chef-solo">Chef Server vs Chef Solo</h4>

<p>Chef comes in two flavours.  Chef Solo and Chef Server.  Chef is always run on the guest or machine being provisioned, not your own machine or workstation.  That means it needs to have the cookbooks copied across in order for it to know where they are.  Chef Server takes care of this for you (the copying across), as well as managing a central repository of your cookbooks.</p>

<p>Chef Server can also do some other fancy stuff (such as provisioning new EC2 instances for you), but unless you’re using it for a live server or professional dev-ops (and we’re not), forget about it.  We can copy the cookbooks across ourselves (or in reality vagrant will).</p>

<p>One final point of note: Opscode (the company behaind chef) will host a Chef server for you, or you can do it yourself.  It would appear Chef can provision it’s own Chef Server, but I’ve not tried.</p>

<h4 id="roles">Roles</h4>

<p>A role is simply a type of server.  E.g. If you have a distributed architecture with a load balancer, 2x web servers and 2x database servers, your roles would be “Load Balancer”, “Web Server”, and “Database Server”.  That’s a role.</p>

<p>A role is not limiting, in reality it’s a name given to a collection of cookbooks you want to run.  E.g. You specify that your webserver roll should run the apache, php, and mysql cookbooks.  The cookbooks that a particular role should run is called a “Run List” in Chef, that’s because the name of the Chef function you pass the cookbooks to run to is <code>run_list</code>.</p>

<h4 id="extra-credit">Extra Credit</h4>

<p>You don’t need to know about this, but I will cover it here for completeness.  Chef also has the concepts of “Nodes” and “Data-Bags”.  I haven’t used these features, but my understanding is that a “Node” is an instance of a Role.  So you have your 2x webservers, each using the “Web Server” role.  Each one of those is a Node.</p>

<p>From my understanding, “Data-Bags” provide additional data to your Recipes, this could be a list of admins or databases to create, or something similar.  I haven’t used them, so I’m not familiar with them.</p>

<h3 id="getting-started">Getting Started</h3>

<p>Now the real quickstart.  You need a directory to hold your Chef related stuff, for simplicity when updating cookbooks, you need that directory managed with git.  This is fairly essential as managing updates to your cookbooks by hand would be a nightmare.  From your application’s root directory run:</p>

<pre><code>cd ../
mkdir -p chef/{cookbooks,data_bags,nodes,roles,site-cookbooks}
cd chef
git init .
</code></pre>

<p>That’s our basic directory structure.  Done.  Next we need to add some cookbooks.  Thankfully, there are a ton of them available on Github<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup> that we can use.  We don’t need to write our own (most tutorials focus on writing your own… I don’t know why).</p>

<p>Now think about what you would normally do when building a new ubuntu VM.  First, you sort out apt to make sure everything is up to date.  Cookbooks live in, unsurprisingly, the cookbooks directory, so lets add the apt cookbook to take care of apt for us:</p>

<pre><code>git submodule add https://github.com/opscode-cookbooks/apt.git cookbooks/apt
</code></pre>

<p>Great, now we want apache2 up and running:</p>

<pre><code>git submodule add https://github.com/opscode-cookbooks/apache2.git cookbooks/apache2
</code></pre>

<p>Boom. Done.  MySQL?</p>

<pre><code>git submodule add https://github.com/opscode-cookbooks/mysql.git cookbooks/mysql
</code></pre>

<p>PHP…</p>

<pre><code>git submodule add https://github.com/opscode-cookbooks/php.git cookbooks/php
</code></pre>

<p>Ok.  We have our cookbooks.  Now we need to add a role so Chef knows which ones to run (you could add a whole bunch of cookbooks here, then in the roll only run a select few).</p>

<p>So, create <code>roles/vagrant-test-box.rb</code> and add the following:</p>

<pre><code># Name of the role should match the name of the file
name "vagrant-test-box"

# Run list function we mentioned earlier
run_list(
    "recipe[apt]",
    "recipe[apache2]",
    "recipe[mysql]",
    "recipe[php]"
)
</code></pre>

<p>That’s it.  Done.  Now lets briefly go back to the Vagrantfile we created in part1:</p>

<pre><code># Enable provisioning with chef solo, specifying a cookbooks path, roles
# path, and data_bags path (all relative to this Vagrantfile), and adding
# some recipes and/or roles.
config.vm.provision :chef_solo do |chef|
    chef.roles_path = "../chef/roles"
    chef.cookbooks_path = ["../chef/site-cookbooks", "../chef/cookbooks"]
    chef.add_role "vagrant-test-box"
end
</code></pre>

<p>See that bit at the bottom.  That’s how vagrant knows to use Chef, and where to find your cookbooks.  If you’ve stored your cookbooks somewhere other than where I’ve suggested, update the paths here, otherwise, let’s update the role to “vagrant-test-box”, as that’s what we just created, and then go back to your application root and run <code>vagrant up</code>.</p>

<p>Everything should run successfully, you’ll see it all whizzing past as Chef installs it, and it will drop you back to a shell prompt with the VM running and provisioned.  Awesome.  You can have a quick test by visiting 192.168.33.33 in your browser, or www.example.vm if you installed the vagrant-hostmaster plugin.</p>

<p><img src="/img/posts/successful-chef-provision.png" alt="Successful Chef Provision" /></p>

<p>Now lets look at what was created in a bit more detail.  Run <code>vagrant ssh</code> to login to the VM.  Now type <code>mysql -u root -p</code>.</p>

<p>Uh oh.  Two problems.  First, we never set a password for the MySQL server, so we can’t login, second, if we run that command without a password, we get the error:</p>

<pre><code>ERROR 2002 (HY000): Can't connect to local MySQL server through socket '/var/run/mysqld/mysqld.sock' (2)
</code></pre>

<p>MySQL Server isn’t installed?? Why??  Lets take a look at the cookbook.</p>

<p>When you add a cookbook to your run list as we did above, Chef will run the default recipe, which can be found in <code>recipes/default.rb</code>.  So let’s take a look at <code>cookbooks/mysql/recipes/default.rb</code> and see what’s going on.</p>

<pre><code>include_recipe "mysql::client"
</code></pre>

<p>Right.  We installed the MySQL Client, but not MySQL Server.  The astute amongst you will have spotted another file in <code>cookbooks/mysql/recipes</code> called <code>server.rb</code>.  A cookbook can contain multiple recipes, and by default the MySQL cookbook only installs the MySQL Client, to install the server we also need to add the MySQL Server recipe to our run list.  You specify a recipe inside a cookbook other than the default using the <code>::</code> syntax you can see above.  Lets modify our <code>vagrant-test-box</code> role to look like this:</p>

<pre><code># Name of the role should match the name of the file
name "vagrant-test-box"

# Run list function we mentioned earlier
run_list(
    "recipe[apt]",
    "recipe[apache2]",
    "recipe[mysql]",
    "recipe[mysql::server]",
    "recipe[php]"
)
</code></pre>

<p>We’ve left the default MySQL recipe in there as we’re going to need the MySQL Client to administer our server.</p>

<p>Now run <code>vagrant provision</code> to run Chef again, and let’s see what happens.</p>

<p>You got an error? Good.  What you’ve just come across is the complete disaster that is Chef error messages.  Totally useless.  What it’s actually complaining about is a missing constant: <code>Opscode::OpenSSL</code>.  This is actually a symptom of something else.  Some cookbooks and recipes have dependencies on other cookbooks and recipes.  Specifically in this instance, the <code>mysql::server</code> recipe depends on the <code>openssl</code> cookbook.</p>

<p>Fortunately for us, the cookbooks in the opscode GitHub repository have fairly good README’s that list their dependencies fairly well.  Let’s take a look at the cookbooks we’ve included so far and see if they have any other dependencies we’ve missed.  Go ahead, I’ll wait.</p>

<p>Great, It looks like only <code>mysql::server</code> has any dependencies.  Apache2 has some dependencies if you’re using RHEL or CentOS, and PHP does if you’re going to build it from source, but we’re not so we can just add the missing openssl cookbook and get on with it:</p>

<pre><code>cd ../chef
git submodule add https://github.com/opscode-cookbooks/openssl.git cookbooks/openssl
</code></pre>

<p>Now let’s add it to our run list before <code>mysql::server</code>:</p>

<pre><code>run_list(
    "recipe[apt]",
    "recipe[openssl]",
    "recipe[apache2]",
    "recipe[mysql]",
    "recipe[mysql::server]",
    "recipe[php]"
)
</code></pre>

<p>I’ve added it to just after apt for neatness.  You can add it anywhere you want before <code>mysql::server</code>.</p>

<p>Now let’s try again:</p>

<pre><code>vagrant provision
</code></pre>

<p>Oh no… another cryptic error.  The key line here is:</p>

<pre><code>FATAL: You must set node['mysql']['server_debian_password'], node['mysql']['server_root_password'], node['mysql']['server_repl_password'] in chef-solo mode. For more information, see https://github.com/opscode-cookbooks/mysql#chef-solo-note
</code></pre>

<p>We forgot to set our root password so we can login to the server, and Chef knows it, so it won’t let us proceed without it.  Now we need to learn about <code>override_attributes</code>.</p>

<pre><code>override_attributes(
    "mysql" =&gt; {
        "server_root_password" =&gt; 'iloverandompasswordsbutthiswilldo',
        "server_repl_password" =&gt; 'iloverandompasswordsbutthiswilldo',
        "server_debian_password" =&gt; 'iloverandompasswordsbutthiswilldo'
    }
)
</code></pre>

<p>Not massively scary.  Put this in your <code>vagrant-test-box.rb</code> role before your run list.  This function allows you to override some defaults setup in the cookbooks on a per-role basis.  Nothing too difficult, it is again often documented in the cookbook’s README, or is fairly easy to find by searching the cookbooks’s templates or recipes for things like:</p>

<pre><code>node['apache']['log_dir']
</code></pre>

<p>That’s a fairly good indication we can overwrite that attribute in our role by adding the key to our override attributes function call:</p>

<pre><code>override_attributes(
    "apache" =&gt; {
        "log_dir" =&gt; "/srv/logs" # new attribute overridden
    },
    "mysql" =&gt; {
        "server_root_password" =&gt; 'iloverandompasswordsbutthiswilldo',
        "server_repl_password" =&gt; 'iloverandompasswordsbutthiswilldo',
        "server_debian_password" =&gt; 'iloverandompasswordsbutthiswilldo'
    }
)
</code></pre>

<p>Ok, don’t add that to your role for real, as we haven’t created that directory so it will cause an error.</p>

<p>Now your role should look like this:</p>

<pre><code># Name of the role should match the name of the file
name "vagrant-test-box"

override_attributes(
    "mysql" =&gt; {
        "server_root_password" =&gt; 'iloverandompasswordsbutthiswilldo',
        "server_repl_password" =&gt; 'iloverandompasswordsbutthiswilldo',
        "server_debian_password" =&gt; 'iloverandompasswordsbutthiswilldo'
    }
)

# Run list function we mentioned earlier
run_list(
    "recipe[apt]",
    "recipe[openssl]",
    "recipe[apache2]",
    "recipe[mysql]",
    "recipe[mysql::server]",
    "recipe[php]"
)
</code></pre>

<p>Save the file and run another <code>vagrant provision</code>.</p>

<p>Are you noticing a pattern here?  Well done.  That’s how we can debug our recipes.  Change -&gt; <code>vagrant provision</code> -&gt; Error -&gt; Repeat until it works.  If the error isn’t obvious, Google is your friend.  Chef will also always give you a stack trace which will show you the recipe and line giving the error, a quick read of the source can usually give you a good indication of what’s really going on.  It reads close to plain English, so you stand a good chance of understanding even if you don’t know Ruby.</p>

<p>This time it should run successfully, so log back in with <code>vagrant ssh</code> and try to connect to MySQL with</p>

<pre><code>mysql -u root -piloverandompasswordsbutthiswilldo
</code></pre>

<p>It should drop you into a <code>mysql&gt;</code> prompt, where you can run <code>show databases;</code>.</p>

<pre><code>mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
+--------------------+
2 rows in set (0.00 sec)
</code></pre>

<p>This is looking good.  Type <code>quit</code> to exit MySQL, now type <code>php --version</code></p>

<pre><code>PHP 5.3.2-1ubuntu4.18 with Suhosin-Patch (cli) (built: Sep 12 2012 19:33:42)
Copyright (c) 1997-2009 The PHP Group
Zend Engine v2.3.0, Copyright (c) 1998-2010 Zend Technologies
</code></pre>

<p>Even better. Now let’s enable the default site and test Apache.</p>

<pre><code>sudo a2ensite default
sudo service apache2 reload
</code></pre>

<p>You’ll notice we didn’t need to type a password, vagrant was good enough to add itself to the automatic sudoer’s list.  Now visit www.example.vm or 192.168.33.33 if you aren’t using the hostmaster plugin.</p>

<p><img src="/img/posts/it-works.png" alt="Apache Default Site" /></p>

<p>We’re getting there.</p>

<pre><code>echo "&lt;?php phpinfo();" | sudo tee /var/www/info.php
</code></pre>

<p>Visit www.example.vm/info.php or 192.168.33.33/info.php to see if it works.  Damn, it downloaded the file.  Ok.  A quick look through the recipes in the Apache2 cookbook shows a <code>mod_php5</code> recipe.  We probably need to add that, so lets add it to our run list and try again:</p>

<pre><code># Run list function we mentioned earlier
run_list(
    "recipe[apt]",
    "recipe[openssl]",
    "recipe[apache2]",
    "recipe[apache2::mod_php5]",
    "recipe[mysql]",
    "recipe[mysql::server]",
    "recipe[php]"
)
</code></pre>

<p>Now run <code>vagrant provision</code> and try to load the info file in our browser again when it’s finished.</p>

<p><img src="/img/posts/not-found.png" alt="Not Found" /></p>

<p>What’s that all about?  Well, Chef has just re-installed everything for you, so Apache’s config is all new again.  Let’s repeat the steps above.  Make a note we need to find a way to make our virtual hosts persistent.  We’ll come back to it soon.</p>

<pre><code>vagrant ssh
sudo a2ensite default
sudo service apache2 reload
echo "&lt;?php phpinfo();" | sudo tee /var/www/info.php
</code></pre>

<p>Now try to load info.php again.</p>

<p><img src="/img/posts/vagrant-phpinfo.png" alt="Vagrant phpinfo()" /></p>

<p>Success!  But a quick scan of the <code>info.php</code> output shows the MySQL section is missing.  Let’s verify that.</p>

<pre><code>php --info | grep mysql
</code></pre>

<p>Nothing.  Let’s check the PHP cookbook.  There’s a <code>module_mysql</code> recipe! Excellent.  Are you spotting another pattern here?  Nothing is enabled by default with the opscode cookbooks, if it’s optional, you have to specify it.</p>

<pre><code># Run list function we mentioned earlier
run_list(
    "recipe[apt]",
    "recipe[openssl]",
    "recipe[apache2]",
    "recipe[apache2::mod_php5]",
    "recipe[mysql]",
    "recipe[mysql::server]",
    "recipe[php]",
    "recipe[php::module_mysql]"
)
</code></pre>

<p>Now run <code>vagrant provision</code> again.</p>

<pre><code>vagrant ssh
php --info | grep mysql
</code></pre>

<p>Much better.</p>

<p><img src="/img/posts/vagrant-mysql-info.png" alt="Vagrant php mysql info" /></p>

<p>That just leaves us with one last thing.  Getting our data and virtual hosts to persist between provisions.</p>

<p>I know I said we wouldn’t need them, but to get our virtual host to point at our code and persist between provisions, we need to use a LWRP.  Specifically the <code>web_app</code> LWRP from the apache2 cookbook.</p>

<p>This may or may not be the <em>right</em> way to do this, but I know it works so it’s how I’m going to do it until I find a better way.  Create a directory in <code>chef/site-cookbooks</code> called <code>apache2</code>.  Inside there, create another directory called <code>recipes</code>.  Now add a file called <code>vhosts.rb</code> with the content:</p>

<pre><code>#
# Cookbook Name:: apache2
# Recipe:: vhosts
#
# Copyright 2012, Adam Brett. All Rights Reserved.
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
include_recipe "apache2"

web_app "example" do
  server_name "www.example.vm"
  server_aliases ["example.vm"]
  allow_override "all"
  docroot "/srv/site/"
end
</code></pre>

<p>Remember how in our <code>Vagrantfile</code> we told Vagrant to mount the current directory at <code>/srv/site</code>?  That’s so our source code was available in the VM.</p>

<p>Now we create a custom recipe (hence the site-cookbooks location), and import the apache2 default recipe.</p>

<p>There’s something important to note here.  If you create a recipe in <code>site-cookbooks</code> that has a recipe of the exact same name and location as one in <code>cookbooks</code>, the one in <code>site-cookbooks</code> will be used.  This allows you to extend or modify the opscode cookbooks without having to modify them directly.  This is why we used git to manage this directory.  We can now very easily update all of our cookbooks with git without worrying about overwriting any of our custom modifications.</p>

<p>The <code>web_app</code> LWRP (or function) is defined in <code>cookbooks/apache2/definitions/web_app.rb</code>. If you open this file and take a look, you can see in here lots of calls to <code>params[:something]</code>.  These are the params you can pass to the function call.  You can also see it’s using the template <code>web_app.conf.erb</code>.  Open this file in the <code>apache2/templates/default</code> directory and you can see a bunch more params you can pass to this function/LWRP.  We only need to use a couple so we’ll leave the recipe as it is.</p>

<p>You include your own recipes in the run list exactly as you would a normal one, so lets add ours:</p>

<pre><code># Run list function we mentioned earlier
run_list(
    "recipe[apt]",
    "recipe[openssl]",
    "recipe[apache2]",
    "recipe[apache2::mod_php5]",
    "recipe[mysql]",
    "recipe[mysql::server]",
    "recipe[php]",
    "recipe[php::module_mysql]",
    "recipe[apache2::vhosts]"
)
</code></pre>

<p>Now run <code>vagrant provision</code> again, and visit www.example.vm in your browser.</p>

<p><img src="/img/posts/vagrant-local-website.png" alt="Vagrant Local Website" /></p>

<p>Success!  Any index.html you have in your application root should now be loaded in your browser.  If you need to load an <code>index.php</code> or something else, add the <code>directory_index</code> paramter to the web_app LWRP call.</p>

<pre><code>web_app "example" do
  server_name "www.example.vm"
  server_aliases ["example.vm"]
  directory_index ["index.html", "index.php"]
  allow_override "all"
  docroot "/srv/site/"
end
</code></pre>

<p>So we’re pretty close.  All that’s left now to have something <em>really</em> useful is to import our database schema.</p>

<p>Fortunately for us, the guys have opscode have a cookbook for that too.  It’s called database, and we’re going to need some LWRP providers from it again.</p>

<pre><code>cd ../chef
git submodule add https://github.com/opscode-cookbooks/database.git cookbooks/database
</code></pre>

<p>The <code>database</code> cookbook recipe <code>mysql</code> has a dependency on the <code>build-essential</code> cookbook, so let’s add that too.</p>

<pre><code>git submodule add https://github.com/opscode-cookbooks/build-essential.git cookbooks/build-essential
</code></pre>

<p>Now add the database::mysql recipe, build-essential default recipe, and another custom one we’re about to create to your run list.</p>

<pre><code># Run list function we mentioned earlier
run_list(
    "recipe[apt]",
    "recipe[build-essential]",
    "recipe[openssl]",
    "recipe[apache2]",
    "recipe[apache2::mod_php5]",
    "recipe[mysql]",
    "recipe[mysql::server]",
    "recipe[php]",
    "recipe[php::module_mysql]",
    "recipe[apache2::vhosts]",
    "recipe[database::mysql]",
    "recipe[database::import]"
)
</code></pre>

<p>Now let’s setup that custom recipe.  Bear in mind, there is probably a <em>correct</em> way to do this.  I’m not aware of it, and this way <em>works</em>:</p>

<pre><code>mkdir -p site-cookbooks/database/recipes
</code></pre>

<p>Then add <code>import.rb</code> in your newly created directory with the following content:</p>

<pre><code>#
# Cookbook Name:: database
# Recipe:: import
#
# Copyright 2012, Adam Brett. All Rights Reserved.
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
include_recipe "database::mysql"

# Store this in a variable so we don't keep repeating it
mysql_connection_info = {
    :host =&gt; "localhost",
    :username =&gt; 'root',
    # automatically get this from the override_attributes call!
    :password =&gt; node['mysql']['server_root_password']
}

# my_database = database name
mysql_database 'my_database' do
  connection mysql_connection_info
  action :create
end

# import an sql dump from your app_root/data/dump.sql to the my_database database
execute "import" do
  command "mysql -u root -p\"#{node['mysql']['server_root_password']}\" my_database &lt; /srv/site/data/dump.sql"
  action :run
end

# this isn't really necessary, as we're using root and not creating a database
# user, but I'm including it and commenting it out so you can see what it looks like
# mysql_database_user 'my_user' do
#  connection mysql_connection_info
#  database_name 'my_database'
#  action :grant
# end
</code></pre>

<p>Now, make sure the database dump exists, and run <code>vagrant provision</code>.</p>

<p>Error!</p>

<p>Again!</p>

<p>It turns out that there is some weirdness with Chef and build-essential and Ruby Gems (which is what gives us the database LWRPs).  A quick scan of the build-essential README reveals we need to add:</p>

<pre><code>default_attributes(
    "build_essential" =&gt; {
        "compiletime" =&gt; true
    }
)
</code></pre>

<p>to our role definition.  Go ahead and do that, so the whole thing should look like this:</p>

<pre><code># Name of the role should match the name of the file
name "vagrant-test-box"

default_attributes(
    "build_essential" =&gt; {
        "compiletime" =&gt; true
    }
)

override_attributes(
    "mysql" =&gt; {
        "server_root_password" =&gt; 'iloverandompasswordsbutthiswilldo',
        "server_repl_password" =&gt; 'iloverandompasswordsbutthiswilldo',
        "server_debian_password" =&gt; 'iloverandompasswordsbutthiswilldo'
    }
)

# Run list function we mentioned earlier
run_list(
    "recipe[apt]",
    "recipe[build-essential]",
    "recipe[openssl]",
    "recipe[apache2]",
    "recipe[apache2::mod_php5]",
    "recipe[mysql]",
    "recipe[mysql::server]",
    "recipe[php]",
    "recipe[php::module_mysql]",
    "recipe[apache2::vhosts]",
    "recipe[database::mysql]",
    "recipe[database::import]"
)
</code></pre>

<p>Then run it again: <code>vagrant provision</code>.</p>

<p>All done? Let’s verify it worked:</p>

<pre><code>vagrant ssh
mysql -u root -piloverandompasswordsbutthiswilldo


mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| my_database        |
| mysql              |
+--------------------+
3 rows in set (0.00 sec)

mysql&gt; use my_database;
Database changed

mysql&gt; show tables;
+-----------------------+
| Tables_in_my_database |
+-----------------------+
| my_table              |
+-----------------------+
1 row in set (0.00 sec)
</code></pre>

<p>Success!  You should now be able to put your vagrant database details into your app and have it load as expected, and if not, I should have given you access to the tools and knowledge you need to start experimenting and debugging for yourself.</p>

<p>In the months and years to come Vagrant and Chef are going to become as indispensable for any serious developer, so please give it a go and let me know on <a href="http://twitter.com/sixdaysad">twitter</a> if there’s anything you think needs improving or clarifying in this post!</p>

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>http://vagrantup.com<a href="#fnref:1" rel="reference">&#8617;</a></p>
    </li>
    <li id="fn:2">
      <p>http://www.opscode.com/chef<a href="#fnref:2" rel="reference">&#8617;</a></p>
    </li>
    <li id="fn:3">
      <p>https://github.com/opscode-cookbooks/<a href="#fnref:3" rel="reference">&#8617;</a></p>
    </li>
  </ol>
</div>

    </div>
</article>


<hr>

<ul class="pager" />
    
    <li class="previous">
        <a href="/2013/01/15/vagrant-is-easy-chef-is-hard.html">&larr; Previous</a>
    </li>
    

    
    <li class="next">
        <a href="/2013/01/24/mimicking-the-recently-not-approved-property-get-set-syntax.html">Next &rarr;</a>
    </li>
    
</ul>


        <footer>
            <p>Copyright &copy; 2012 <a href="http://adambrett.co.uk">Adam Brett</a>.  All rights reserved.</p>
        </footer>
    </section>

    <script type="text/javascript" src="http://platform.twitter.com/widgets.js?ver=1.1"></script>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-10572636-6']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
</body>
</html>
